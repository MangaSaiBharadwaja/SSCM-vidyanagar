<!-- #sagar -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Service Selection Cards -->
    <div class="row g-4 mb-4" id="serviceCards">
        {% for service_id, price in service_prices.items() %}
        <div class="col-md-4 col-lg-3 service-card-wrapper">
            <div class="card h-100 service-card" data-service-id="{{ service_id }}" data-service-name="{{ service_types[service_id]['name'] }}" data-service-price="{{ price }}" style="cursor: pointer;">
                <div class="card-body">
                    <h5 class="card-title">{{ service_types[service_id]['name'].replace('_', ' ').title() }}</h5>
                    <p class="card-text">Price: ₹{{ price }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h6>Reports</h6>
                            <div class="d-flex">
                                <select id="reportMonth" class="form-select me-2" style="width: auto;">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                                <select id="reportYear" class="form-select me-2" style="width: auto;">
                                    <option value="2024">2024</option>
                                    <option value="2025" selected>2025</option>
                                </select>
                                <button id="generateReportBtn" class="btn btn-success">
                                    <i class="bi bi-file-earmark-excel"></i> Generate Monthly Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div class="modal fade" id="serviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="selectedServiceTitle"></h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="templeServiceForm">
                        <input type="hidden" id="serviceType" name="serviceType">
                        <input type="hidden" id="invoiceType" name="invoiceType" value="TOKEN">
                        <input type="hidden" id="printData" name="printData">

                        <!-- Frequency (Only for Abhishekam) -->
                        <div class="mb-4" id="frequencySection" style="display: none;">
                            <label class="form-label">Select Frequency *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="frequency" id="single" value="SINGLE"
                                    required checked>
                                <label class="btn btn-outline-primary" for="single">Single</label>
                                <input type="radio" class="btn-check" name="frequency" id="weekly" value="WEEKLY">
                                <label class="btn btn-outline-primary" for="weekly">Weekly</label>
                                <input type="radio" class="btn-check" name="frequency" id="monthly" value="MONTHLY">
                                <label class="btn btn-outline-primary" for="monthly">Monthly</label>
                            </div>
                            <div class="form-text text-end" id="amountDisplay">
                                Amount: ₹<span id="amount">0</span>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <label class="form-label">Select Payment Method *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="paymentMethod" id="upi" value="UPI"
                                    required>
                                <label class="btn btn-outline-primary" for="upi">UPI</label>
                                <input type="radio" class="btn-check" name="paymentMethod" id="cash" value="CASH">
                                <label class="btn btn-outline-primary" for="cash">Cash</label>
                                <input type="radio" class="btn-check" name="paymentMethod" id="card" value="CARD">
                                <label class="btn btn-outline-primary" for="card">Card</label>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        <div id="additionalDetails">
                            <!-- Devotee Details Section -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Devotee Details</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Gothram *</label>
                                            <input type="text" class="form-control" name="gothram" id="gothram"
                                                required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Name *</label>
                                            <input type="text" class="form-control" name="devoteeName" id="devoteeName"
                                                required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Contact Number</label>
                                            <input type="tel" class="form-control" name="devoteeContactNum"
                                                id="devoteeContactNum">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Puja Details *</label>
                                            <textarea class="form-control" name="pujaDetails" id="pujaDetails" rows="2"
                                                required></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="card mb-4">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Address Details</h5>
                                    <div class="form-check mb-0">
                                        <input class="form-check-input" type="checkbox" id="includeAddress">
                                        <label class="form-check-label" for="includeAddress">
                                            Include Address
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body" id="addressFields" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Address Line 1</label>
                                            <input type="text" class="form-control" name="address[address1]">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Address Line 2</label>
                                            <input type="text" class="form-control" name="address[address2]">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">City</label>
                                            <input type="text" class="form-control" name="address[city]">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">District</label>
                                            <input type="text" class="form-control" name="address[district]">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">State</label>
                                            <input type="text" class="form-control" name="address[state]">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Pincode</label>
                                            <input type="text" class="form-control" name="address[pincode]">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Generate Token</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal with Print Option -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Service Created Successfully</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage"></p>
                    <div id="serviceDetails"></div>
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-primary" id="printPreviewBtn">
                            <i class="bi bi-printer"></i> Print Preview
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div class="modal fade" id="printPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Print Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Token Print Preview (55mm) -->
                    <div id="tokenPreview" class="d-none">
                        <div class="token-print">
                            <div class="text-center">
                                <h1 class="temple-name">SSCM</h1>
                                <h2 class="service-name mb-3"></h2>
                                <div class="token-number mb-2"></div>
                                <div class="valid-till mb-3"></div>
                                <div class="amount"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Receipt Print Preview (Full A4) -->
                    <div id="receiptPreview" class="d-none">
                        <div class="receipt-print">
                            <!-- Office Copy -->
                            <div class="receipt-copy office-copy">
                                <div class="text-center">
                                    <h2 class="temple-name">Shirdi Sai Cultural Mission</h2>
                                    <p class="temple-address">Vidyanagar, Tirupati District, Andhra Pradesh. -524413
                                        <br> Contact Number - 9705894817</p>
                                    <h2 class="service-name mb-3"></h2>
                                </div>
                                <div class="receipt-content">
                                    <div class="receipt-left">
                                        <div class="receipt-number mb-2">
                                            <span class="field-label">Receipt No:</span>
                                            <span class="receipt-value"></span>
                                        </div>
                                        <div class="gothram-details mb-2">
                                            <span class="field-label">Gothram:</span>
                                            <span class="gothram-value"></span>
                                        </div>
                                        <div class="devotee-details mb-2">
                                            <span class="field-label">Name:</span>
                                            <span class="devotee-value"></span>
                                        </div>
                                        <div class="puja-details mb-2">
                                            <span class="field-label">Puja Details:</span>
                                            <span class="puja-value"></span>
                                        </div>
                                        <div class="address-details mb-3">
                                            <span class="field-label">Address:</span>
                                            <span class="address-value"></span>
                                        </div>
                                    </div>
                                    <div class="receipt-right">
                                        <div class="amount-section">
                                            <div class="amount-words mb-2">
                                                <span class="field-label">Amount in Words:</span>
                                                <span class="amount-words-value"></span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="amount">
                                                    <span class="field-label">Amount:</span>
                                                    <span class="amount-value"></span>
                                                </div>
                                                <div class="signature-section">
                                                    Signature
                                                    <div class="signature-line"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Devotee Copy -->
                            <div class="receipt-copy devotee-copy">
                                <div class="text-center">
                                    <h2 class="temple-name">Shirdi Sai Cultural Mission</h2>
                                    <p class="temple-address">Vidyanagar, Tirupati District, Andhra Pradesh. -524413
                                        <br> Contact Number - 9705894817</p>
                                    <h2 class="service-name mb-3"></h2>
                                </div>
                                <div class="receipt-content">
                                    <div class="receipt-left">
                                        <div class="receipt-number mb-2">
                                            <span class="field-label">Receipt No:</span>
                                            <span class="receipt-value"></span>
                                        </div>
                                        <div class="gothram-details mb-2">
                                            <span class="field-label">Gothram:</span>
                                            <span class="gothram-value"></span>
                                        </div>
                                        <div class="devotee-details mb-2">
                                            <span class="field-label">Name:</span>
                                            <span class="devotee-value"></span>
                                        </div>
                                        <div class="puja-details mb-2">
                                            <span class="field-label">Puja Details:</span>
                                            <span class="puja-value"></span>
                                        </div>
                                        <div class="address-details mb-3">
                                            <span class="field-label">Address:</span>
                                            <span class="address-value"></span>
                                        </div>
                                    </div>
                                    <div class="receipt-right">
                                        <div class="amount-section">
                                            <div class="amount-words mb-2">
                                                <span class="field-label">Amount in Words:</span>
                                                <span class="amount-words-value"></span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="amount">
                                                    <span class="field-label">Amount:</span>
                                                    <span class="amount-value"></span>
                                                </div>
                                                <div class="signature-section">
                                                    Signature
                                                    <div class="signature-line"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printDocument()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const serviceModal = document.getElementById('serviceModal');
        const serviceCards = document.querySelectorAll('.service-card');
        const selectedServiceTitle = document.getElementById('selectedServiceTitle');
        const templeServiceForm = document.getElementById('templeServiceForm');
        const includeAddress = document.getElementById('includeAddress');
        const addressFields = document.getElementById('addressFields');
        const devoteeDetails = document.getElementById('additionalDetails');
        const frequencySection = document.getElementById('frequencySection');
        const frequencyInputs = document.querySelectorAll('input[name="frequency"]');
        let currentServiceId = null;
        let currentServicePrice = 0;

    // Service card click handler
    serviceCards.forEach(card => {
        card.addEventListener('click', () => {
            const serviceId = card.dataset.serviceId;
            const serviceName = card.dataset.serviceName.replace(/_/g, ' ').toLowerCase()
                                  .replace(/\b\w/g, c => c.toUpperCase());
            currentServiceId = serviceId;
            currentServicePrice = parseFloat(card.dataset.servicePrice);
            
            // Update modal title
            selectedServiceTitle.textContent = serviceName;
            document.getElementById('serviceType').value = serviceId;
            
            // Reset form
            templeServiceForm.reset();
            
            // Update form fields based on service type
            updateFormFields(serviceId);
            updateAmount();

            // Show the modal
            const serviceModalInstance = new bootstrap.Modal(serviceModal);
            serviceModalInstance.show();
        });
    });
        // Toggle address fields
        includeAddress.addEventListener('change', (e) => {
            addressFields.style.display = e.target.checked ? 'block' : 'none';
        });

        // Update amount when frequency changes
        frequencyInputs.forEach(input => {
            input.addEventListener('change', () => {
                updateFormFields(currentServiceId);
                updateAmount();
            });
        });

        // Update form fields based on service type and frequency
        function updateFormFields(serviceId) {
            const isAbhishekam = serviceId === '1';
            const isArchana = serviceId === '2';
            const frequencyValue = document.querySelector('input[name="frequency"]:checked')?.value;

            // Handle invoice type internally
            const invoiceTypeInput = document.getElementById('invoiceType');

            if (isAbhishekam) {
                // Show frequency for Abhishekam
                frequencySection.style.display = 'block';
                // Set invoice type based on frequency
                invoiceTypeInput.value = frequencyValue === 'SINGLE' ? 'TOKEN' : 'RECEIPT';
                // Show additional details for weekly/monthly
                devoteeDetails.style.display = frequencyValue === 'SINGLE' ? 'none' : 'block';
            } else if (isArchana) {
                // Hide frequency for Archana
                frequencySection.style.display = 'none';
                // Always token for Archana
                invoiceTypeInput.value = 'TOKEN';
                // Hide additional details
                devoteeDetails.style.display = 'none';
            } else {
                // Hide frequency for other services
                frequencySection.style.display = 'none';
                // Always receipt for other services
                invoiceTypeInput.value = 'RECEIPT';
                // Show additional details
                devoteeDetails.style.display = 'block';
            }

            // Update required fields
            const nameInput = document.getElementById('devoteeName');
            const gothramInput = document.getElementById('gothram');
            const pujaDetailsInput = document.getElementById('pujaDetails');

            const requireFields = devoteeDetails.style.display === 'block';
            nameInput.required = requireFields;
            gothramInput.required = requireFields;
            pujaDetailsInput.required = requireFields;
        }

        // Update amount based on frequency
        function updateAmount() {
            let finalAmount = currentServicePrice;

            if (frequencySection.style.display === 'block') {
                const frequency = document.querySelector('input[name="frequency"]:checked').value;
                if (frequency === 'WEEKLY') {
                    finalAmount *= 7;
                } else if (frequency === 'MONTHLY') {
                    finalAmount *= 30;
                }
            }

            document.getElementById('amount').textContent = finalAmount.toFixed(2);
        }

        // Form submission
        templeServiceForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {};

            // Extract service type first
            const serviceType = formData.get('serviceType');

            // Build data object
            formData.forEach((value, key) => {
                if (key.startsWith('address[')) {
                    const addressKey = key.match(/\[(.*?)\]/)[1];
                    if (!data.address) data.address = {};
                    if (value) data.address[addressKey] = value;
                } else if (key !== 'serviceType') { // Skip serviceType as it goes in URL
                    data[key] = value;
                }
            });

            try {
                const response = await fetch(`/temple-management/services?serviceType=${serviceType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Server Response:', result); // Debug log

                if (response.ok) {
                    // Hide service modal
                    const serviceModalInstance = bootstrap.Modal.getInstance(serviceModal);
                    serviceModalInstance.hide();

                    // Store print data
                    const printData = {
                        invoiceType: data.invoiceType,
                        invoiceNumber: result.id,
                        serviceName: result.serviceName,
                        gothram: result.gothram,
                        devoteeName: result.devoteeName,
                        pujaDetails: result.pujaDetails,
                        address: result.address,
                        amount: result.amount,
                        validTill: result.validTill
                    };
                    document.getElementById('printData').value = JSON.stringify(printData);

                    // Directly show print preview
                    updatePrintPreview(printData);

                    // Reset form
                    templeServiceForm.reset();
                } else {
                    throw new Error(result.message || 'Failed to create service');
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                errorModal.show();
            }
        });

        // Form validation
        function validateForm() {
            const requiredFields = templeServiceForm.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            return isValid;
        }

        // Print preview functions
        function updatePrintPreview(printData) {
            console.log('Print Preview Data:', printData); // Debug log

            if (!printData) {
                printData = JSON.parse(document.getElementById('printData').value);
            }

            // Clear both previews
            document.getElementById('tokenPreview').classList.add('d-none');
            document.getElementById('receiptPreview').classList.add('d-none');

            if (printData.invoiceType === 'TOKEN') {
                // Token preview (55mm)
                const tokenPreview = document.getElementById('tokenPreview');
                tokenPreview.classList.remove('d-none');
                tokenPreview.querySelector('.service-name').textContent = printData.serviceName;
                tokenPreview.querySelector('.token-number').textContent = printData.invoiceNumber;
                tokenPreview.querySelector('.valid-till').textContent = `Valid till: ${formatDateToIndian(printData.validTill)}`;
                tokenPreview.querySelector('.amount').textContent = `₹${printData.amount}/-`;
            } else {
                // Receipt preview (Full A4)
                const receiptPreview = document.getElementById('receiptPreview');
                receiptPreview.classList.remove('d-none');
                // Update both copies
                const receiptCopies = receiptPreview.querySelectorAll('.receipt-copy');
                receiptCopies.forEach(copy => {
                    copy.querySelector('.service-name').textContent = printData.serviceName;
                    copy.querySelector('.receipt-value').textContent = printData.invoiceNumber || '';
                    copy.querySelector('.gothram-value').textContent = printData.gothram || '';
                    copy.querySelector('.devotee-value').textContent = printData.devoteeName || '';
                    copy.querySelector('.puja-value').textContent = printData.pujaDetails || '';

                    // Format address
                    const address = printData.address;
                    const formattedAddress = address ?
                        `${address.address1 || ''} ${address.address2 || ''} ${address.address3 || ''} ${address.address4 || ''}\n` +
                        `${address.city || ''} ${address.district || ''} ${address.state || ''} ${address.pincode || ''}`
                        : '';
                    copy.querySelector('.address-value').textContent = formattedAddress;

                    // Convert amount to words
                    const amountInWords = numberToWords(printData.amount);
                    copy.querySelector('.amount-words-value').textContent = `${amountInWords} rupees only`;

                    // Format amount with currency symbol
                    copy.querySelector('.amount-value').textContent = `₹${printData.amount}/-`;
                });
            }

            // Hide success modal and show print preview modal
            const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
            const printPreviewModal = new bootstrap.Modal(document.getElementById('printPreviewModal'));

            if (successModal) {
                successModal.hide();
            }
            printPreviewModal.show();
        }

        // Format date to Indian format (DD/MM/YYYY)
        function formatDateToIndian(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function to convert number to words
        function numberToWords(number) {
            const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

            if (number === 0) return 'Zero';

            function convert(n) {
                if (n < 20) return units[n];
                if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + units[n % 10] : '');
                if (n < 1000) return units[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + convert(n % 100) : '');
                if (n < 100000) return convert(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + convert(n % 1000) : '');
                return convert(Math.floor(n / 100000)) + ' Lakh' + (n % 100000 ? ' ' + convert(n % 100000) : '');
            }

            return convert(number);
        }

        // Print document function
        function printDocument() {
            const printWindow = window.open('', '_blank');
            const isToken = document.getElementById('tokenPreview').classList.contains('d-none') === false;
            const content = document.getElementById(isToken ? 'tokenPreview' : 'receiptPreview').cloneNode(true);

            // Copy all styles from the page
            const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
                .map(el => el.outerHTML)
                .join('\n');

            printWindow.document.write(`
        <html>
            <head>
                <title>Print</title>
                ${styles}
                <style>
                    @page {
                        size: ${isToken ? '55mm auto' : 'A4 portrait'};
                        margin: 10mm;
                    }
                    body {
                        margin: 0;
                        padding: 10mm;
                    }
                    .receipt-print {
                        width: ${isToken ? '45mm' : '190mm'};
                        margin: 0 auto;
                    }
                    .receipt-copy {
                        page-break-after: avoid;
                    }
                </style>
            </head>
            <body>
                ${content.innerHTML}
            </body>
        </html>
    `);
            printWindow.document.close();
            printWindow.print();
        }

        // Add click handler for print preview button
        document.getElementById('printPreviewBtn').addEventListener('click', function () {
            const printData = JSON.parse(document.getElementById('printData').value);
            updatePrintPreview(printData);
        });
        document.querySelector('[onclick="printDocument()"]').addEventListener('click', printDocument);

        // Set current month in the report dropdown
        const currentMonth = new Date().getMonth() + 1; // JavaScript months are 0-indexed
        document.getElementById('reportMonth').value = currentMonth;

        // Add click handler for report generation
        document.getElementById('generateReportBtn').addEventListener('click', function () {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;

            // Navigate to the report URL
            window.location.href = `/reports/monthly?year=${year}&month=${month}`;
        });
    });
</script>

<style>
    .service-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Card Colors */
    .service-card-wrapper:nth-child(8n+1) .service-card {
        background: linear-gradient(135deg, #fcf8a7, #fcf8a7);
    }

    .service-card-wrapper:nth-child(8n+2) .service-card {
        background: linear-gradient(135deg, #fcc5ee, #fcc5ee);
    }

    .service-card-wrapper:nth-child(8n+3) .service-card {
        background: linear-gradient(135deg, #dcb9ff, #dcb9ff);
    }

    .service-card-wrapper:nth-child(8n+4) .service-card {
        background: linear-gradient(135deg, #DFFFBF, #DFFFBF);
    }

    .service-card-wrapper:nth-child(8n+5) .service-card {
        background: linear-gradient(135deg, #c3e6ff, #c3e6ff);
    }

    .service-card-wrapper:nth-child(8n+6) .service-card {
        background: linear-gradient(135deg, #d3f9d8, #d3f9d8);
    }

    .service-card-wrapper:nth-child(8n+7) .service-card {
        background: linear-gradient(135deg, #fedb92, #fedb92);
    }

    .service-card-wrapper:nth-child(8n+8) .service-card {
        background: linear-gradient(135deg, #ff9191, #ff9191);
    }

    .btn-check:checked+.btn-outline-primary {
        background-color: #0d6efd !important;
        color: white !important;
    }

    .card-header {
        background-color: #f8f9fa;
    }

    .modal-lg {
        max-width: 800px;
    }

    /* Print Preview Styles */
    .token-print {
        background: white;
        padding: 10px;
        border: 1px solid #ddd;
        margin: 0 auto;
        width: 55mm;
    }

    .receipt-print {
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
        margin: 0 auto;
        width: 190mm;
        /* Full A4 width */
        height: 277mm;
        /* Full A4 height */
    }

    .receipt-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .receipt-left {
        border-right: 1px dashed #ccc;
        padding-right: 20px;
    }

    .receipt-right {
        padding-left: 20px;
    }

    .amount-section {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }

    .signature-section {
        text-align: center;
        margin-top: 20px;
    }

    .temple-name {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .service-name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .temple-address {
        margin-bottom: 15px;
    }

    .temple-contact-number {
        margin-bottom: 15px;
    }

    .amount {
        font-size: 20px;
        font-weight: bold;
    }

    .field-label {
        font-weight: bold;
        display: inline-block;
        margin-right: 5px;
    }

    .receipt-copy {
        position: relative;
        padding-bottom: 20mm;
    }

    .receipt-copy::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        border-bottom: 2px dotted #000;
    }

    .receipt-copy {
        page-break-after: always;
        margin-bottom: 20mm;
    }

    .office-copy::before {
        content: "Office Copy";
        display: block;
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .devotee-copy::before {
        content: "Devotee Copy";
        display: block;
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
    }

    @media print {
        @page {
            size: A4 portrait;
            margin: 10mm;
        }

        body {
            margin: 0;
            padding: 10mm;
            font-family: Arial, sans-serif;
        }

        .receipt-print {
            width: 190mm;
            height: 277mm;
            margin: 0 auto;
        }

        .receipt-copy {
            page-break-after: avoid;
        }
    }
</style>
{% endblock %}